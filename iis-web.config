<?xml version="1.0" encoding="UTF-8"?>
<!--
============================================
Configuration IIS Reverse Proxy pour GeStock
Windows Server - Production
============================================

PRÉREQUIS IIS:
1. Installer "URL Rewrite Module": https://www.iis.net/downloads/microsoft/url-rewrite
2. Installer "Application Request Routing (ARR)": https://www.iis.net/downloads/microsoft/application-request-routing
3. Activer ARR Proxy:
   - Ouvrir IIS Manager
   - Cliquer sur le serveur (niveau racine)
   - Double-cliquer "Application Request Routing Cache"
   - Cliquer "Server Proxy Settings" (panneau de droite)
   - Cocher "Enable proxy"
   - Appliquer

INSTALLATION:
Placer ce fichier dans le répertoire racine du site IIS
Exemple: C:\inetpub\wwwroot\gestock\web.config
-->

<configuration>
  <system.webServer>
    
    <!-- ============================================
         Reverse Proxy vers Next.js (localhost:3000)
         ============================================ -->
    <rewrite>
      <rules>
        
        <!-- Règle principale: Proxy toutes requêtes vers Node.js -->
        <rule name="ReverseProxyToNextJS" stopProcessing="true">
          <match url="(.*)" />
          <conditions logicalGrouping="MatchAll" trackAllCaptures="false">
            <!-- Ne pas proxy les fichiers statiques IIS existants -->
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
          </conditions>
          <action type="Rewrite" url="http://localhost:3000/{R:1}" />
          <serverVariables>
            <set name="HTTP_X_FORWARDED_PROTO" value="https" />
            <set name="HTTP_X_FORWARDED_HOST" value="{HTTP_HOST}" />
          </serverVariables>
        </rule>

        <!-- Health check endpoint -->
        <rule name="HealthCheck" stopProcessing="true">
          <match url="^health$" />
          <action type="Rewrite" url="http://localhost:3000/api/health" />
        </rule>

      </rules>
      
      <!-- Headers sortants -->
      <outboundRules>
        <!-- Réécrire les redirections -->
        <rule name="ReverseProxyOutboundRule" preCondition="ResponseIsHtml">
          <match filterByTags="A, Form, Img" pattern="^http(s)?://localhost:3000/(.*)" />
          <action type="Rewrite" value="http{R:1}://{HTTP_HOST}/{R:2}" />
        </rule>
        <preConditions>
          <preCondition name="ResponseIsHtml">
            <add input="{RESPONSE_CONTENT_TYPE}" pattern="^text/html" />
          </preCondition>
        </preConditions>
      </outboundRules>
    </rewrite>

    <!-- ============================================
         Headers HTTP sécurité
         ============================================ -->
    <httpProtocol>
      <customHeaders>
        <remove name="X-Powered-By" />
        <add name="X-Frame-Options" value="SAMEORIGIN" />
        <add name="X-Content-Type-Options" value="nosniff" />
        <add name="X-XSS-Protection" value="1; mode=block" />
        <add name="Referrer-Policy" value="strict-origin-when-cross-origin" />
        <!-- HSTS: Active uniquement en HTTPS -->
        <!-- <add name="Strict-Transport-Security" value="max-age=31536000; includeSubDomains" /> -->
      </customHeaders>
    </httpProtocol>

    <!-- ============================================
         Compression
         ============================================ -->
    <urlCompression doStaticCompression="true" doDynamicCompression="true" />
    <httpCompression>
      <dynamicTypes>
        <add mimeType="text/*" enabled="true" />
        <add mimeType="message/*" enabled="true" />
        <add mimeType="application/javascript" enabled="true" />
        <add mimeType="application/json" enabled="true" />
        <add mimeType="application/xml" enabled="true" />
        <add mimeType="*/*" enabled="false" />
      </dynamicTypes>
      <staticTypes>
        <add mimeType="text/*" enabled="true" />
        <add mimeType="message/*" enabled="true" />
        <add mimeType="application/javascript" enabled="true" />
        <add mimeType="application/json" enabled="true" />
        <add mimeType="*/*" enabled="false" />
      </staticTypes>
    </httpCompression>

    <!-- ============================================
         Cache fichiers statiques
         ============================================ -->
    <staticContent>
      <!-- Cache Next.js static files -->
      <clientCache cacheControlMode="UseMaxAge" cacheControlMaxAge="365.00:00:00" />
      
      <!-- MIME types pour Next.js -->
      <remove fileExtension=".json" />
      <mimeMap fileExtension=".json" mimeType="application/json" />
      <remove fileExtension=".woff" />
      <mimeMap fileExtension=".woff" mimeType="font/woff" />
      <remove fileExtension=".woff2" />
      <mimeMap fileExtension=".woff2" mimeType="font/woff2" />
    </staticContent>

    <!-- ============================================
         Limite upload (images produits)
         ============================================ -->
    <security>
      <requestFiltering>
        <!-- 10 MB maximum -->
        <requestLimits maxAllowedContentLength="10485760" />
      </requestFiltering>
    </security>

    <!-- ============================================
         Redirection HTTP vers HTTPS (optionnel)
         ============================================ -->
    <!--
    <rewrite>
      <rules>
        <rule name="HTTP to HTTPS redirect" stopProcessing="true">
          <match url="(.*)" />
          <conditions>
            <add input="{HTTPS}" pattern="off" ignoreCase="true" />
          </conditions>
          <action type="Redirect" url="https://{HTTP_HOST}/{R:1}" redirectType="Permanent" />
        </rule>
      </rules>
    </rewrite>
    -->

    <!-- ============================================
         Variables serveur pour ARR
         ============================================ -->
    <rewrite>
      <allowedServerVariables>
        <add name="HTTP_X_FORWARDED_PROTO" />
        <add name="HTTP_X_FORWARDED_HOST" />
        <add name="HTTP_X_REAL_IP" />
      </allowedServerVariables>
    </rewrite>

  </system.webServer>
</configuration>
